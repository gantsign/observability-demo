---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: prometheus
  namespace: grafana
spec:
  repo: https://prometheus-community.github.io/helm-charts
  chart: prometheus
  targetNamespace: grafana
  valuesContent: |-
    server:
      extraFlags:
      - web.enable-lifecycle
      - web.enable-remote-write-receiver
      - enable-feature=exemplar-storage
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: tempo
  namespace: grafana
spec:
  repo: https://grafana.github.io/helm-charts
  chart: tempo
  targetNamespace: grafana
  valuesContent: |-
    tempo:
      metricsGenerator:
        enabled: true
        remoteWriteUrl: http://prometheus-server.grafana.svc.cluster.local/api/v1/write
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: loki
  namespace: grafana
spec:
  repo: https://grafana.github.io/helm-charts
  chart: loki
  targetNamespace: grafana
  valuesContent: |-
    loki:
      commonConfig:
        replication_factor: 1
      storage:
        type: filesystem
    singleBinary:
      replicas: 1
    gateway:
      enabled: false
    test:
      enabled: false
    monitoring:
      dashboards:
        enabled: false
      lokiCanary:
        enabled: false
      serviceMonitor:
        enabled: false
      selfMonitoring:
        enabled: false
        grafanaAgent:
          installOperator: false
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: grafana
  namespace: grafana
spec:
  repo: https://grafana.github.io/helm-charts
  chart: grafana
  targetNamespace: grafana
  valuesContent: |-
    adminUser: admin
    adminPassword: 'change me before use'
    env:
      GF_AUTH_ANONYMOUS_ENABLED: 'true'
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
      GF_AUTH_DISABLE_LOGIN_FORM: 'true'
      GF_FEATURE_TOGGLES_ENABLE: traceqlEditor
    grafana.ini:
      server:
        domain: localhost
        root_url: "%(protocol)s://%(domain)s/grafana"
        serve_from_sub_path: true
    ingress:
      ingressClassName: traefik
      enabled: true
      hosts: []
      path: /grafana
    datasources:
      datasources.yml:
        apiVersion: 1
        datasources:
        - name: Prometheus
          type: prometheus
          uid: prometheus
          access: proxy
          orgId: 1
          url: http://prometheus-server.grafana.svc.cluster.local
          basicAuth: false
          isDefault: false
          version: 1
          editable: false
          jsonData:
            httpMethod: GET
        - name: Tempo
          type: tempo
          uid: tempo
          access: proxy
          url: http://tempo:3100
          basicAuth: false
          isDefault: true
          editable: false
          jsonData:
            tracesToLogsV2:
              datasourceUid: loki
              spanStartTimeShift: '-1h'
              spanEndTimeShift: '1h'
              tags:
              - key: service.name
                value: job
              filterByTraceID: true
              filterBySpanID: false
              customQuery: false
            serviceMap:
              datasourceUid: prometheus
            nodeGraph:
              enabled: true
            search:
              hide: false
            lokiSearch:
              datasourceUid: loki
            traceQuery:
              timeShiftEnabled: true
              spanStartTimeShift: '-1h'
              spanEndTimeShift: '1h'
            spanBar:
              type: Tag
              tag: http.target
        - name: Loki
          type: loki
          uid: loki
          access: proxy
          orgId: 1
          url: http://loki:3100
          basicAuth: false
          isDefault: false
          version: 1
          editable: false
          jsonData:
            httpHeaderName1: X-Scope-OrgID
            derivedFields:
            - datasourceUid: tempo
              matcherRegex: \btrace_id=([a-f0-9]+)\b
              name: TraceID
              url: '$${__value.raw}'
          secureJsonData:
            httpHeaderValue1: tenant1
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
        - name: default
          orgId: 1
          folder: ''
          type: file
          disableDeletion: false
          editable: false
          options:
            path: /var/lib/grafana/dashboards/default
    dashboards:
      default:
        micrometer:
          # Ref: https://grafana.com/grafana/dashboards/4701-jvm-micrometer/
          gnetId: 4701
          revision: 10
          datasource: prometheus
        springboot:
          # Ref: https://grafana.com/grafana/dashboards/19004-spring-boot-statistics/
          gnetId: 19004
          revision: 1
          datasource:
          - name: DS_PROMETHEUS
            value: prometheus
        springboot-observability:
          # Ref: https://grafana.com/grafana/dashboards/17175-spring-boot-observability/
          gnetId: 17175
          revision: 1
          datasource:
          - name: DS_PROMETHEUS
            value: prometheus
          - name: DS_LOKI
            value: loki
        springboot-observability2:
          json: |
            {
              "annotations": {
                "list": [
                  {
                    "builtIn": 1,
                    "datasource": {
                      "type": "datasource",
                      "uid": "grafana"
                    },
                    "enable": true,
                    "hide": true,
                    "iconColor": "rgba(0, 211, 255, 1)",
                    "name": "Annotations & Alerts",
                    "target": {
                      "limit": 100,
                      "matchAny": false,
                      "tags": [],
                      "type": "dashboard"
                    },
                    "type": "dashboard"
                  }
                ]
              },
              "description": "Observe Spring Boot application with three pillars of observability: Traces (Tempo), Metrics (Prometheus), Logs (Loki) on Grafana through OpenTelemetry and OpenMetrics.",
              "editable": true,
              "fiscalYearStartMonth": 0,
              "graphTooltip": 0,
              "id": 5,
              "links": [],
              "liveNow": false,
              "panels": [
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          }
                        ]
                      },
                      "unit": "short"
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 6,
                    "w": 4,
                    "x": 0,
                    "y": 0
                  },
                  "id": 4,
                  "options": {
                    "colorMode": "value",
                    "graphMode": "area",
                    "justifyMode": "auto",
                    "orientation": "auto",
                    "reduceOptions": {
                      "calcs": [
                        "lastNotNull"
                      ],
                      "fields": "",
                      "values": false
                    },
                    "textMode": "auto"
                  },
                  "pluginVersion": "9.5.5",
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": true,
                      "expr": "sum(http_server_requests_seconds_count{application=\"$app_name\", uri!=\"/actuator/prometheus\"})",
                      "interval": "",
                      "legendFormat": "",
                      "range": true,
                      "refId": "A"
                    }
                  ],
                  "timeFrom": "24h",
                  "title": "Total Requests",
                  "type": "stat"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "continuous-GrYlRd"
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          },
                          {
                            "color": "red",
                            "value": 80
                          }
                        ]
                      },
                      "unit": "s"
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 13,
                    "w": 4,
                    "x": 4,
                    "y": 0
                  },
                  "id": 6,
                  "options": {
                    "displayMode": "lcd",
                    "minVizHeight": 10,
                    "minVizWidth": 0,
                    "orientation": "horizontal",
                    "reduceOptions": {
                      "calcs": [
                        "lastNotNull"
                      ],
                      "fields": "",
                      "values": false
                    },
                    "showUnfilled": true,
                    "text": {
                      "titleSize": 12,
                      "valueSize": 12
                    },
                    "valueMode": "color"
                  },
                  "pluginVersion": "9.5.5",
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "topk(10, sum by(uri)(http_server_requests_seconds_sum{application=\"$app_name\"}) / sum by(uri)(http_server_requests_seconds_count{application=\"$app_name\"}))",
                      "instant": true,
                      "interval": "",
                      "legendFormat": "{{method}} {{uri}}",
                      "range": false,
                      "refId": "A"
                    }
                  ],
                  "title": "Requests Average Duration",
                  "transformations": [],
                  "type": "bargauge"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "continuous-GrYlRd"
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          },
                          {
                            "color": "red",
                            "value": 80
                          }
                        ]
                      },
                      "unit": "reqps"
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 13,
                    "w": 4,
                    "x": 8,
                    "y": 0
                  },
                  "id": 24,
                  "options": {
                    "displayMode": "lcd",
                    "minVizHeight": 10,
                    "minVizWidth": 0,
                    "orientation": "horizontal",
                    "reduceOptions": {
                      "calcs": [
                        "lastNotNull"
                      ],
                      "fields": "",
                      "values": false
                    },
                    "showUnfilled": true,
                    "text": {
                      "titleSize": 12,
                      "valueSize": 12
                    },
                    "valueMode": "color"
                  },
                  "pluginVersion": "9.5.5",
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "topk(10, sum by(uri)(rate(http_server_requests_seconds_count{application=\"$app_name\"}[1m])))",
                      "instant": true,
                      "interval": "",
                      "legendFormat": "{{uri}}",
                      "range": false,
                      "refId": "A"
                    }
                  ],
                  "title": "Request Per Sec",
                  "type": "bargauge"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "thresholds"
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          }
                        ]
                      },
                      "unit": "short"
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 13,
                    "w": 4,
                    "x": 12,
                    "y": 0
                  },
                  "id": 16,
                  "options": {
                    "displayMode": "lcd",
                    "minVizHeight": 10,
                    "minVizWidth": 0,
                    "orientation": "horizontal",
                    "reduceOptions": {
                      "calcs": [
                        "lastNotNull"
                      ],
                      "fields": "",
                      "values": false
                    },
                    "showUnfilled": true,
                    "text": {
                      "titleSize": 12,
                      "valueSize": 12
                    },
                    "valueMode": "color"
                  },
                  "pluginVersion": "9.5.5",
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "topk(10, sum by(uri) (http_server_requests_seconds_count{application=\"$app_name\", uri!=\"/actuator/prometheus\"}))",
                      "instant": true,
                      "interval": "",
                      "legendFormat": "{{method}} {{uri}}",
                      "range": false,
                      "refId": "A"
                    }
                  ],
                  "timeFrom": "24h",
                  "title": "Requests Count",
                  "type": "bargauge"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "palette-classic"
                      },
                      "custom": {
                        "axisCenteredZero": false,
                        "axisColorMode": "text",
                        "axisLabel": "",
                        "axisPlacement": "auto",
                        "axisSoftMax": 1,
                        "barAlignment": 0,
                        "drawStyle": "line",
                        "fillOpacity": 0,
                        "gradientMode": "none",
                        "hideFrom": {
                          "legend": false,
                          "tooltip": false,
                          "viz": false
                        },
                        "lineInterpolation": "linear",
                        "lineWidth": 1,
                        "pointSize": 5,
                        "scaleDistribution": {
                          "type": "linear"
                        },
                        "showPoints": "auto",
                        "spanNulls": false,
                        "stacking": {
                          "group": "A",
                          "mode": "none"
                        },
                        "thresholdsStyle": {
                          "mode": "area"
                        }
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "red",
                            "value": null
                          },
                          {
                            "color": "green",
                            "value": 0.8
                          }
                        ]
                      },
                      "unit": "percentunit"
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 7,
                    "w": 8,
                    "x": 16,
                    "y": 0
                  },
                  "id": 18,
                  "options": {
                    "legend": {
                      "calcs": [],
                      "displayMode": "list",
                      "placement": "bottom",
                      "showLegend": true
                    },
                    "tooltip": {
                      "mode": "single",
                      "sort": "none"
                    }
                  },
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": true,
                      "expr": "sum by(uri) (http_server_requests_seconds_count{application=\"$app_name\", status=~\"2.*\", uri!=\"/actuator/prometheus\"}) / sum by(uri) (http_server_requests_seconds_count{application=\"$app_name\", uri!=\"/actuator/prometheus\"})",
                      "interval": "",
                      "legendFormat": "{{path}}",
                      "range": true,
                      "refId": "A"
                    }
                  ],
                  "title": "Percent of 2xx Requests",
                  "type": "timeseries"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "thresholds"
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          },
                          {
                            "color": "red",
                            "value": 80
                          }
                        ]
                      }
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 7,
                    "w": 4,
                    "x": 0,
                    "y": 6
                  },
                  "id": 22,
                  "options": {
                    "colorMode": "value",
                    "graphMode": "area",
                    "justifyMode": "auto",
                    "orientation": "auto",
                    "reduceOptions": {
                      "calcs": [
                        "lastNotNull"
                      ],
                      "fields": "",
                      "values": false
                    },
                    "textMode": "auto"
                  },
                  "pluginVersion": "9.5.5",
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": true,
                      "expr": "sum(http_server_requests_seconds_count{application=\"$app_name\", outcome=\"SERVER_ERROR\"})",
                      "interval": "",
                      "legendFormat": "",
                      "range": true,
                      "refId": "A"
                    }
                  ],
                  "timeFrom": "24h",
                  "title": "Total Exceptions",
                  "type": "stat"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "palette-classic"
                      },
                      "custom": {
                        "axisCenteredZero": false,
                        "axisColorMode": "text",
                        "axisLabel": "",
                        "axisPlacement": "auto",
                        "axisSoftMax": 1,
                        "barAlignment": 0,
                        "drawStyle": "line",
                        "fillOpacity": 0,
                        "gradientMode": "none",
                        "hideFrom": {
                          "legend": false,
                          "tooltip": false,
                          "viz": false
                        },
                        "lineInterpolation": "linear",
                        "lineWidth": 1,
                        "pointSize": 5,
                        "scaleDistribution": {
                          "type": "linear"
                        },
                        "showPoints": "auto",
                        "spanNulls": false,
                        "stacking": {
                          "group": "A",
                          "mode": "none"
                        },
                        "thresholdsStyle": {
                          "mode": "area"
                        }
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          },
                          {
                            "color": "red",
                            "value": 0.1
                          }
                        ]
                      },
                      "unit": "percentunit"
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 6,
                    "w": 8,
                    "x": 16,
                    "y": 7
                  },
                  "id": 20,
                  "options": {
                    "legend": {
                      "calcs": [],
                      "displayMode": "list",
                      "placement": "bottom",
                      "showLegend": true
                    },
                    "tooltip": {
                      "mode": "single",
                      "sort": "none"
                    }
                  },
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": true,
                      "expr": "sum by(uri) (http_server_requests_seconds_count{application=\"$app_name\", status=~\"5.*\", uri!=\"/actuator/prometheus\"}) / sum by(uri) (http_server_requests_seconds_count{application=\"$app_name\", uri!=\"/actuator/prometheus\"})",
                      "interval": "",
                      "legendFormat": "{{uri}}",
                      "range": true,
                      "refId": "A"
                    }
                  ],
                  "title": "Percent of 5xx Requests",
                  "type": "timeseries"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "palette-classic"
                      },
                      "custom": {
                        "axisCenteredZero": false,
                        "axisColorMode": "text",
                        "axisLabel": "",
                        "axisPlacement": "auto",
                        "barAlignment": 0,
                        "drawStyle": "line",
                        "fillOpacity": 0,
                        "gradientMode": "none",
                        "hideFrom": {
                          "legend": false,
                          "tooltip": false,
                          "viz": false
                        },
                        "lineInterpolation": "linear",
                        "lineWidth": 1,
                        "pointSize": 5,
                        "scaleDistribution": {
                          "type": "linear"
                        },
                        "showPoints": "auto",
                        "spanNulls": false,
                        "stacking": {
                          "group": "A",
                          "mode": "none"
                        },
                        "thresholdsStyle": {
                          "mode": "off"
                        }
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          },
                          {
                            "color": "red",
                            "value": 80
                          }
                        ]
                      },
                      "unit": "s"
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 8,
                    "w": 8,
                    "x": 0,
                    "y": 13
                  },
                  "id": 8,
                  "options": {
                    "legend": {
                      "calcs": [],
                      "displayMode": "list",
                      "placement": "bottom",
                      "showLegend": true
                    },
                    "tooltip": {
                      "mode": "single",
                      "sort": "none"
                    }
                  },
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": true,
                      "expr": "histogram_quantile(.99,sum(rate(http_server_requests_seconds_bucket{application=\"$app_name\", uri!=\"/actuator/prometheus\"}[1m])) by(uri, le))",
                      "interval": "",
                      "legendFormat": "{{uri}}",
                      "range": true,
                      "refId": "A"
                    }
                  ],
                  "title": "PR 99 Requests Duration",
                  "type": "timeseries"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "palette-classic"
                      },
                      "custom": {
                        "axisCenteredZero": false,
                        "axisColorMode": "text",
                        "axisLabel": "",
                        "axisPlacement": "auto",
                        "barAlignment": 0,
                        "drawStyle": "line",
                        "fillOpacity": 0,
                        "gradientMode": "none",
                        "hideFrom": {
                          "legend": false,
                          "tooltip": false,
                          "viz": false
                        },
                        "lineInterpolation": "linear",
                        "lineWidth": 1,
                        "pointSize": 5,
                        "scaleDistribution": {
                          "type": "linear"
                        },
                        "showPoints": "auto",
                        "spanNulls": false,
                        "stacking": {
                          "group": "A",
                          "mode": "none"
                        },
                        "thresholdsStyle": {
                          "mode": "off"
                        }
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          },
                          {
                            "color": "red",
                            "value": 80
                          }
                        ]
                      },
                      "unit": "s"
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 8,
                    "w": 8,
                    "x": 8,
                    "y": 13
                  },
                  "id": 23,
                  "options": {
                    "legend": {
                      "calcs": [],
                      "displayMode": "list",
                      "placement": "bottom",
                      "showLegend": true
                    },
                    "tooltip": {
                      "mode": "single",
                      "sort": "none"
                    }
                  },
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": true,
                      "expr": "histogram_quantile(.95,sum(rate(http_server_requests_seconds_bucket{application=\"$app_name\", uri!=\"/actuator/prometheus\"}[1m])) by(uri, le))",
                      "interval": "",
                      "legendFormat": "{{uri}}",
                      "range": true,
                      "refId": "A"
                    }
                  ],
                  "title": "PR 95 Requests Duration",
                  "type": "timeseries"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "palette-classic"
                      },
                      "custom": {
                        "axisCenteredZero": false,
                        "axisColorMode": "text",
                        "axisLabel": "",
                        "axisPlacement": "auto",
                        "barAlignment": 0,
                        "drawStyle": "line",
                        "fillOpacity": 0,
                        "gradientMode": "none",
                        "hideFrom": {
                          "legend": false,
                          "tooltip": false,
                          "viz": false
                        },
                        "lineInterpolation": "linear",
                        "lineWidth": 1,
                        "pointSize": 5,
                        "scaleDistribution": {
                          "type": "linear"
                        },
                        "showPoints": "auto",
                        "spanNulls": false,
                        "stacking": {
                          "group": "A",
                          "mode": "none"
                        },
                        "thresholdsStyle": {
                          "mode": "off"
                        }
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          },
                          {
                            "color": "red",
                            "value": 80
                          }
                        ]
                      },
                      "unit": "reqps"
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 8,
                    "w": 8,
                    "x": 16,
                    "y": 13
                  },
                  "id": 12,
                  "options": {
                    "legend": {
                      "calcs": [],
                      "displayMode": "list",
                      "placement": "bottom",
                      "showLegend": true
                    },
                    "tooltip": {
                      "mode": "single",
                      "sort": "none"
                    }
                  },
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": true,
                      "expr": "sum by(uri)(rate(http_server_requests_seconds_count{application=\"$app_name\"}[1m]))",
                      "interval": "",
                      "legendFormat": "{{uri}}",
                      "range": true,
                      "refId": "A"
                    }
                  ],
                  "title": "Request Per Sec",
                  "type": "timeseries"
                },
                {
                  "datasource": {
                    "type": "loki",
                    "uid": "loki"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "palette-classic"
                      },
                      "custom": {
                        "axisCenteredZero": false,
                        "axisColorMode": "text",
                        "axisLabel": "",
                        "axisPlacement": "auto",
                        "barAlignment": 0,
                        "drawStyle": "bars",
                        "fillOpacity": 0,
                        "gradientMode": "none",
                        "hideFrom": {
                          "legend": false,
                          "tooltip": false,
                          "viz": false
                        },
                        "lineInterpolation": "linear",
                        "lineWidth": 1,
                        "pointSize": 5,
                        "scaleDistribution": {
                          "type": "linear"
                        },
                        "showPoints": "auto",
                        "spanNulls": false,
                        "stacking": {
                          "group": "A",
                          "mode": "normal"
                        },
                        "thresholdsStyle": {
                          "mode": "off"
                        }
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          },
                          {
                            "color": "red",
                            "value": 80
                          }
                        ]
                      }
                    },
                    "overrides": [
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "ERROR"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "red",
                              "mode": "fixed"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "INFO"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "green",
                              "mode": "fixed"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "CRITICAL"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "purple",
                              "mode": "fixed"
                            }
                          }
                        ]
                      }
                    ]
                  },
                  "gridPos": {
                    "h": 9,
                    "w": 6,
                    "x": 0,
                    "y": 21
                  },
                  "id": 14,
                  "options": {
                    "legend": {
                      "calcs": [],
                      "displayMode": "list",
                      "placement": "bottom",
                      "showLegend": true
                    },
                    "tooltip": {
                      "mode": "single",
                      "sort": "none"
                    }
                  },
                  "pluginVersion": "8.4.3",
                  "targets": [
                    {
                      "datasource": {
                        "type": "loki",
                        "uid": "loki"
                      },
                      "editorMode": "code",
                      "expr": "sum by(type) (rate({compose_service=~\"app-.*\"} | pattern `<datetime> <_>=<trace_id> <_>=<span_id> <_>=<trace_flags> <type> <_> --- <msg>` | type != \"\" |= \"$log_keyword\" [1m]))",
                      "legendFormat": "{{type}}",
                      "queryType": "range",
                      "refId": "A"
                    }
                  ],
                  "title": "Log Type Rate",
                  "type": "timeseries"
                },
                {
                  "datasource": {
                    "type": "loki",
                    "uid": "loki"
                  },
                  "gridPos": {
                    "h": 9,
                    "w": 18,
                    "x": 6,
                    "y": 21
                  },
                  "id": 2,
                  "options": {
                    "dedupStrategy": "none",
                    "enableLogDetails": true,
                    "prettifyLogMessage": false,
                    "showCommonLabels": false,
                    "showLabels": false,
                    "showTime": false,
                    "sortOrder": "Descending",
                    "wrapLogMessage": true
                  },
                  "pluginVersion": "8.4.3",
                  "targets": [
                    {
                      "datasource": {
                        "type": "loki",
                        "uid": "loki"
                      },
                      "editorMode": "code",
                      "expr": "{compose_service=~\"app-.*\"} | pattern `<datetime> <_>=<trace_id> <_>=<span_id> <_>=<trace_flags> <type> <_> --- <msg>` | line_format \"{{.compose_service}}\\t{{.type}}\\ttrace_id={{.trace_id}}\\t{{.msg}}\" |= \"$log_keyword\"",
                      "hide": false,
                      "queryType": "range",
                      "refId": "A"
                    }
                  ],
                  "title": "Log of All Spring Boot Apps",
                  "type": "logs"
                }
              ],
              "refresh": "5s",
              "schemaVersion": 38,
              "style": "dark",
              "tags": [],
              "templating": {
                "list": [
                  {
                    "current": {
                      "selected": false,
                      "text": "app-petclinic",
                      "value": "app-petclinic"
                    },
                    "datasource": {
                      "type": "prometheus",
                      "uid": "prometheus"
                    },
                    "definition": "label_values(application)",
                    "hide": 0,
                    "includeAll": false,
                    "label": "Application Name",
                    "multi": false,
                    "name": "app_name",
                    "options": [],
                    "query": {
                      "query": "label_values(application)",
                      "refId": "StandardVariableQuery"
                    },
                    "refresh": 1,
                    "regex": "",
                    "skipUrlSync": false,
                    "sort": 0,
                    "type": "query"
                  },
                  {
                    "current": {
                      "selected": false,
                      "text": "",
                      "value": ""
                    },
                    "description": "query with keyword",
                    "hide": 0,
                    "label": "Log Query",
                    "name": "log_keyword",
                    "options": [
                      {
                        "selected": true,
                        "text": "",
                        "value": ""
                      }
                    ],
                    "query": "",
                    "skipUrlSync": false,
                    "type": "textbox"
                  }
                ]
              },
              "time": {
                "from": "now-5m",
                "to": "now"
              },
              "timepicker": {},
              "timezone": "",
              "title": "Spring Boot Observability 2",
              "uid": "dLsDQIUnzb2j",
              "version": 1,
              "weekStart": ""
            }
        spanmetrics:
          json: |
            {
              "annotations": {
                "list": [
                  {
                    "builtIn": 1,
                    "datasource": {
                      "type": "grafana",
                      "uid": "-- Grafana --"
                    },
                    "enable": true,
                    "hide": true,
                    "iconColor": "rgba(0, 211, 255, 1)",
                    "name": "Annotations & Alerts",
                    "target": {
                      "limit": 100,
                      "matchAny": false,
                      "tags": [],
                      "type": "dashboard"
                    },
                    "type": "dashboard"
                  }
                ]
              },
              "description": "Spanmetrics way of application view.",
              "editable": true,
              "fiscalYearStartMonth": 0,
              "graphTooltip": 0,
              "id": 8,
              "links": [],
              "liveNow": false,
              "panels": [
                {
                  "collapsed": true,
                  "gridPos": {
                    "h": 1,
                    "w": 24,
                    "x": 0,
                    "y": 0
                  },
                  "id": 24,
                  "panels": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "fieldConfig": {
                        "defaults": {
                          "color": {
                            "mode": "continuous-BlYlRd"
                          },
                          "mappings": [],
                          "thresholds": {
                            "mode": "absolute",
                            "steps": [
                              {
                                "color": "blue",
                                "value": null
                              },
                              {
                                "color": "green",
                                "value": 2
                              },
                              {
                                "color": "#EAB839",
                                "value": 64
                              },
                              {
                                "color": "orange",
                                "value": 128
                              },
                              {
                                "color": "red",
                                "value": 256
                              }
                            ]
                          },
                          "unit": "ms"
                        },
                        "overrides": []
                      },
                      "gridPos": {
                        "h": 20,
                        "w": 12,
                        "x": 0,
                        "y": 1
                      },
                      "id": 2,
                      "interval": "5m",
                      "options": {
                        "orientation": "auto",
                        "reduceOptions": {
                          "calcs": [
                            "lastNotNull"
                          ],
                          "fields": "",
                          "values": false
                        },
                        "showThresholdLabels": false,
                        "showThresholdMarkers": true
                      },
                      "pluginVersion": "9.5.5",
                      "targets": [
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "editorMode": "code",
                          "exemplar": false,
                          "expr": "topk(7,histogram_quantile(0.50, sum(rate(duration_bucket{service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__rate_interval])) by (le,service_name)))",
                          "format": "time_series",
                          "hide": true,
                          "instant": false,
                          "interval": "",
                          "legendFormat": "{{service_name}}-quantile_0.50",
                          "range": true,
                          "refId": "A"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "editorMode": "code",
                          "exemplar": false,
                          "expr": "topk(7,histogram_quantile(0.95, sum(rate(duration_bucket{service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__range])) by (le,service_name)))",
                          "hide": false,
                          "instant": true,
                          "interval": "",
                          "legendFormat": "{{le}} - {{service_name}}",
                          "range": false,
                          "refId": "B"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "editorMode": "code",
                          "exemplar": false,
                          "expr": "histogram_quantile(0.99, sum(rate(duration_bucket{service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__rate_interval])) by (le,service_name))",
                          "hide": true,
                          "interval": "",
                          "legendFormat": "quantile99",
                          "range": true,
                          "refId": "C"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "editorMode": "code",
                          "exemplar": false,
                          "expr": "histogram_quantile(0.999, sum(rate(duration_bucket{service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__rate_interval])) by (le,service_name))",
                          "hide": true,
                          "interval": "",
                          "legendFormat": "quantile999",
                          "range": true,
                          "refId": "D"
                        }
                      ],
                      "title": "Top 3x3 - Service Latency - quantile95",
                      "type": "gauge"
                    },
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "fieldConfig": {
                        "defaults": {
                          "color": {
                            "mode": "continuous-BlYlRd"
                          },
                          "decimals": 2,
                          "mappings": [],
                          "thresholds": {
                            "mode": "absolute",
                            "steps": [
                              {
                                "color": "green",
                                "value": null
                              },
                              {
                                "color": "super-light-blue",
                                "value": 1
                              },
                              {
                                "color": "#EAB839",
                                "value": 2
                              },
                              {
                                "color": "red",
                                "value": 10
                              }
                            ]
                          },
                          "unit": "reqps"
                        },
                        "overrides": []
                      },
                      "gridPos": {
                        "h": 13,
                        "w": 12,
                        "x": 12,
                        "y": 1
                      },
                      "id": 4,
                      "interval": "5m",
                      "options": {
                        "displayMode": "lcd",
                        "minVizHeight": 10,
                        "minVizWidth": 0,
                        "orientation": "horizontal",
                        "reduceOptions": {
                          "calcs": [
                            "mean"
                          ],
                          "fields": "",
                          "values": false
                        },
                        "showUnfilled": true,
                        "text": {},
                        "valueMode": "color"
                      },
                      "pluginVersion": "9.5.5",
                      "targets": [
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "editorMode": "code",
                          "exemplar": false,
                          "expr": "topk(7,sum by (service_name) (rate( calls{service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__range])))",
                          "format": "time_series",
                          "instant": true,
                          "interval": "",
                          "legendFormat": "{{service_name}}",
                          "range": false,
                          "refId": "A"
                        }
                      ],
                      "title": "Top 7 Services Mean Rate over Range",
                      "transformations": [],
                      "type": "bargauge"
                    },
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "fieldConfig": {
                        "defaults": {
                          "color": {
                            "mode": "continuous-reds"
                          },
                          "decimals": 4,
                          "mappings": [],
                          "thresholds": {
                            "mode": "absolute",
                            "steps": [
                              {
                                "color": "green",
                                "value": null
                              },
                              {
                                "color": "#EAB839",
                                "value": 1
                              },
                              {
                                "color": "red",
                                "value": 15
                              }
                            ]
                          },
                          "unit": "reqps"
                        },
                        "overrides": []
                      },
                      "gridPos": {
                        "h": 7,
                        "w": 12,
                        "x": 12,
                        "y": 14
                      },
                      "id": 15,
                      "interval": "5m",
                      "options": {
                        "displayMode": "lcd",
                        "minVizHeight": 10,
                        "minVizWidth": 0,
                        "orientation": "vertical",
                        "reduceOptions": {
                          "calcs": [
                            "mean"
                          ],
                          "fields": "",
                          "values": false
                        },
                        "showUnfilled": true,
                        "text": {},
                        "valueMode": "color"
                      },
                      "pluginVersion": "9.5.5",
                      "targets": [
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "editorMode": "code",
                          "exemplar": false,
                          "expr": "topk(7,sum(rate( calls{status_code=\"STATUS_CODE_ERROR\",service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__range])) by (service_name))",
                          "instant": true,
                          "interval": "",
                          "legendFormat": "{{service_name}}",
                          "range": false,
                          "refId": "A"
                        }
                      ],
                      "title": "Top 7 Services Mean ERROR Rate over Range",
                      "transformations": [],
                      "type": "bargauge"
                    }
                  ],
                  "title": "Service Level - Throughput and Latencies",
                  "type": "row"
                },
                {
                  "collapsed": false,
                  "datasource": {
                    "type": "prometheus",
                    "uid": "webstore-metrics"
                  },
                  "gridPos": {
                    "h": 1,
                    "w": 24,
                    "x": 0,
                    "y": 1
                  },
                  "id": 14,
                  "panels": [],
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "webstore-metrics"
                      },
                      "refId": "A"
                    }
                  ],
                  "title": "Operations Level - Throughput",
                  "type": "row"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "description": "",
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "thresholds"
                      },
                      "custom": {
                        "align": "auto",
                        "cellOptions": {
                          "type": "auto"
                        },
                        "inspect": false
                      },
                      "decimals": 2,
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          },
                          {
                            "color": "red",
                            "value": 80
                          }
                        ]
                      },
                      "unit": "reqps"
                    },
                    "overrides": [
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "bRate"
                        },
                        "properties": [
                          {
                            "id": "custom.cellOptions",
                            "value": {
                              "mode": "lcd",
                              "type": "gauge"
                            }
                          },
                          {
                            "id": "color",
                            "value": {
                              "mode": "continuous-BlYlRd"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "eRate"
                        },
                        "properties": [
                          {
                            "id": "custom.cellOptions",
                            "value": {
                              "mode": "lcd",
                              "type": "gauge"
                            }
                          },
                          {
                            "id": "color",
                            "value": {
                              "mode": "continuous-RdYlGr"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "Error Rate"
                        },
                        "properties": [
                          {
                            "id": "custom.width",
                            "value": 663
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "Rate"
                        },
                        "properties": [
                          {
                            "id": "custom.width",
                            "value": 667
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "Service"
                        },
                        "properties": [
                          {
                            "id": "custom.width"
                          }
                        ]
                      }
                    ]
                  },
                  "gridPos": {
                    "h": 11,
                    "w": 24,
                    "x": 0,
                    "y": 2
                  },
                  "id": 22,
                  "interval": "5m",
                  "options": {
                    "cellHeight": "sm",
                    "footer": {
                      "countRows": false,
                      "fields": "",
                      "reducer": [
                        "sum"
                      ],
                      "show": false
                    },
                    "showHeader": true,
                    "sortBy": []
                  },
                  "pluginVersion": "9.5.5",
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "exemplar": false,
                      "expr": "topk(7, sum(rate(calls{service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__range])) by (span_name,service_name)) ",
                      "format": "table",
                      "instant": true,
                      "interval": "",
                      "legendFormat": "",
                      "refId": "Rate"
                    },
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "exemplar": false,
                      "expr": "topk(7, sum(rate(calls{status_code=\"STATUS_CODE_ERROR\",service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__range])) by (span_name,service_name))",
                      "format": "table",
                      "hide": false,
                      "instant": true,
                      "interval": "",
                      "legendFormat": "",
                      "refId": "Error Rate"
                    }
                  ],
                  "title": "Top 7 Operations and Errors  (APM Table)",
                  "transformations": [
                    {
                      "id": "seriesToColumns",
                      "options": {
                        "byField": "span_name"
                      }
                    },
                    {
                      "id": "organize",
                      "options": {
                        "excludeByName": {
                          "Time 1": true,
                          "Time 2": true
                        },
                        "indexByName": {},
                        "renameByName": {
                          "Value #Error Rate": "Error Rate",
                          "Value #Rate": "Rate",
                          "service_name 1": "Rate in Service",
                          "service_name 2": "Error Rate in Service"
                        }
                      }
                    },
                    {
                      "id": "calculateField",
                      "options": {
                        "alias": "bRate",
                        "mode": "reduceRow",
                        "reduce": {
                          "include": [
                            "Rate"
                          ],
                          "reducer": "sum"
                        }
                      }
                    },
                    {
                      "id": "calculateField",
                      "options": {
                        "alias": "eRate",
                        "mode": "reduceRow",
                        "reduce": {
                          "include": [
                            "Error Rate"
                          ],
                          "reducer": "sum"
                        }
                      }
                    },
                    {
                      "id": "organize",
                      "options": {
                        "excludeByName": {
                          "Error Rate": true,
                          "Rate": true,
                          "bRate": false
                        },
                        "indexByName": {
                          "Error Rate": 4,
                          "Error Rate in Service": 6,
                          "Rate": 1,
                          "Rate in Service": 5,
                          "bRate": 2,
                          "eRate": 3,
                          "span_name": 0
                        },
                        "renameByName": {
                          "Rate in Service": "Service",
                          "bRate": "Rate",
                          "eRate": "Error Rate",
                          "span_name": "Operation Name"
                        }
                      }
                    },
                    {
                      "id": "sortBy",
                      "options": {
                        "fields": {},
                        "sort": [
                          {
                            "desc": true,
                            "field": "Rate"
                          }
                        ]
                      }
                    }
                  ],
                  "type": "table"
                },
                {
                  "collapsed": false,
                  "datasource": {
                    "type": "prometheus",
                    "uid": "webstore-metrics"
                  },
                  "gridPos": {
                    "h": 1,
                    "w": 24,
                    "x": 0,
                    "y": 13
                  },
                  "id": 20,
                  "panels": [],
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "webstore-metrics"
                      },
                      "refId": "A"
                    }
                  ],
                  "title": "Operation Level - Latencies",
                  "type": "row"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "continuous-BlYlRd"
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "blue",
                            "value": null
                          },
                          {
                            "color": "green",
                            "value": 2
                          },
                          {
                            "color": "#EAB839",
                            "value": 64
                          },
                          {
                            "color": "orange",
                            "value": 128
                          },
                          {
                            "color": "red",
                            "value": 256
                          }
                        ]
                      },
                      "unit": "ms"
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 13,
                    "w": 12,
                    "x": 0,
                    "y": 14
                  },
                  "id": 25,
                  "interval": "5m",
                  "options": {
                    "orientation": "auto",
                    "reduceOptions": {
                      "calcs": [
                        "lastNotNull"
                      ],
                      "fields": "",
                      "values": false
                    },
                    "showThresholdLabels": false,
                    "showThresholdMarkers": true
                  },
                  "pluginVersion": "9.5.5",
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "topk(7,histogram_quantile(0.50, sum(rate(duration_bucket{service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__rate_interval])) by (le,service_name)))",
                      "format": "time_series",
                      "hide": true,
                      "instant": false,
                      "interval": "",
                      "legendFormat": "{{service_name}}-quantile_0.50",
                      "range": true,
                      "refId": "A"
                    },
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "topk(7,histogram_quantile(0.95, sum(rate(duration_bucket{service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__range])) by (le,span_name)))",
                      "hide": false,
                      "instant": true,
                      "interval": "",
                      "legendFormat": "{{span_name}}",
                      "range": false,
                      "refId": "B"
                    },
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "histogram_quantile(0.99, sum(rate(duration_bucket{service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__rate_interval])) by (le,service_name))",
                      "hide": true,
                      "interval": "",
                      "legendFormat": "quantile99",
                      "range": true,
                      "refId": "C"
                    },
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "histogram_quantile(0.999, sum(rate(duration_bucket{service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__rate_interval])) by (le,service_name))",
                      "hide": true,
                      "interval": "",
                      "legendFormat": "quantile999",
                      "range": true,
                      "refId": "D"
                    }
                  ],
                  "title": "Top 3x3 - Operation Latency - quantile95",
                  "type": "gauge"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "continuous-BlYlRd"
                      },
                      "decimals": 2,
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          },
                          {
                            "color": "red",
                            "value": 80
                          }
                        ]
                      },
                      "unit": "ms"
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 13,
                    "w": 12,
                    "x": 12,
                    "y": 14
                  },
                  "id": 10,
                  "interval": "5m",
                  "options": {
                    "displayMode": "lcd",
                    "minVizHeight": 10,
                    "minVizWidth": 0,
                    "orientation": "horizontal",
                    "reduceOptions": {
                      "calcs": [
                        "mean"
                      ],
                      "fields": "",
                      "values": false
                    },
                    "showUnfilled": true,
                    "valueMode": "color"
                  },
                  "pluginVersion": "9.5.5",
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "topk(7, sum by (span_name,service_name)(increase(duration_sum{service_name=~\"${service}\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[5m]) / increase(duration_count{service_name=~\"${service}\",span_name=~\"$span_name\"}[5m\n])))",
                      "instant": true,
                      "interval": "",
                      "legendFormat": "{{span_name}} [{{service_name}}]",
                      "range": false,
                      "refId": "A"
                    }
                  ],
                  "title": "Top 7 Highest Endpoint Latencies  Mean Over Range ",
                  "transformations": [],
                  "type": "bargauge"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "palette-classic"
                      },
                      "custom": {
                        "axisCenteredZero": false,
                        "axisColorMode": "text",
                        "axisLabel": "",
                        "axisPlacement": "auto",
                        "barAlignment": 0,
                        "drawStyle": "line",
                        "fillOpacity": 15,
                        "gradientMode": "none",
                        "hideFrom": {
                          "legend": false,
                          "tooltip": false,
                          "viz": false
                        },
                        "lineInterpolation": "smooth",
                        "lineWidth": 1,
                        "pointSize": 5,
                        "scaleDistribution": {
                          "type": "linear"
                        },
                        "showPoints": "auto",
                        "spanNulls": false,
                        "stacking": {
                          "group": "A",
                          "mode": "none"
                        },
                        "thresholdsStyle": {
                          "mode": "off"
                        }
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          },
                          {
                            "color": "red",
                            "value": 80
                          }
                        ]
                      },
                      "unit": "ms"
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 12,
                    "w": 24,
                    "x": 0,
                    "y": 27
                  },
                  "id": 16,
                  "interval": "5m",
                  "options": {
                    "legend": {
                      "calcs": [
                        "mean",
                        "logmin",
                        "max",
                        "delta"
                      ],
                      "displayMode": "table",
                      "placement": "bottom",
                      "showLegend": true
                    },
                    "tooltip": {
                      "mode": "single",
                      "sort": "none"
                    }
                  },
                  "pluginVersion": "8.4.7",
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus"
                      },
                      "editorMode": "code",
                      "exemplar": true,
                      "expr": "topk(7,sum by (span_name,service_name)(increase(duration_sum{service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__rate_interval]) / increase(duration_count{service_name=~\"$service\", span_name=~\"$span_name\",  span_kind=~\"$span_kind\"}[$__rate_interval])))",
                      "instant": false,
                      "interval": "",
                      "legendFormat": "[{{service_name}}]  {{span_name}}",
                      "range": true,
                      "refId": "A"
                    }
                  ],
                  "title": "Top 7 Latencies Over Range ",
                  "type": "timeseries"
                }
              ],
              "refresh": "5m",
              "schemaVersion": 38,
              "style": "dark",
              "tags": [
                "apm",
                "spanmetrics",
                "opentelemetry"
              ],
              "templating": {
                "list": [
                  {
                    "allValue": ".*",
                    "current": {
                      "selected": true,
                      "text": [
                        "All"
                      ],
                      "value": [
                        "$__all"
                      ]
                    },
                    "datasource": {
                      "type": "prometheus",
                      "uid": "prometheus"
                    },
                    "definition": "query_result(count by (service_name)(count_over_time({__name__=~\"calls\"}[$__range])))",
                    "hide": 0,
                    "includeAll": true,
                    "multi": true,
                    "name": "service",
                    "options": [],
                    "query": {
                      "query": "query_result(count by (service_name)(count_over_time({__name__=~\"calls\"}[$__range])))",
                      "refId": "PrometheusVariableQueryEditor-VariableQuery"
                    },
                    "refresh": 2,
                    "regex": "/.*service_name=\"(.*)\".*/",
                    "skipUrlSync": false,
                    "sort": 1,
                    "type": "query"
                  },
                  {
                    "current": {
                      "selected": true,
                      "text": [
                        "SPAN_KIND_SERVER"
                      ],
                      "value": [
                        "SPAN_KIND_SERVER"
                      ]
                    },
                    "datasource": {
                      "type": "prometheus",
                      "uid": "prometheus"
                    },
                    "definition": "query_result(sum ({__name__=~\"calls\",service_name=~\"$service\"})  by (span_kind))",
                    "hide": 0,
                    "includeAll": true,
                    "multi": true,
                    "name": "span_kind",
                    "options": [],
                    "query": {
                      "query": "query_result(sum ({__name__=~\"calls\",service_name=~\"$service\"})  by (span_kind))",
                      "refId": "PrometheusVariableQueryEditor-VariableQuery"
                    },
                    "refresh": 2,
                    "regex": "/.*span_kind=\"(.*)\".*/",
                    "skipUrlSync": false,
                    "sort": 0,
                    "type": "query"
                  },
                  {
                    "allValue": ".*",
                    "current": {
                      "selected": true,
                      "text": [
                        "All"
                      ],
                      "value": [
                        "$__all"
                      ]
                    },
                    "datasource": {
                      "type": "prometheus",
                      "uid": "prometheus"
                    },
                    "definition": "query_result(sum ({__name__=~\"calls\",service_name=~\"$service\", span_kind=~\"$span_kind\"})  by (span_name))",
                    "hide": 0,
                    "includeAll": true,
                    "label": "operation",
                    "multi": true,
                    "name": "span_name",
                    "options": [],
                    "query": {
                      "query": "query_result(sum ({__name__=~\"calls\",service_name=~\"$service\", span_kind=~\"$span_kind\"})  by (span_name))",
                      "refId": "PrometheusVariableQueryEditor-VariableQuery"
                    },
                    "refresh": 2,
                    "regex": "/.*span_name=\"(.*)\".*/",
                    "skipUrlSync": false,
                    "sort": 0,
                    "type": "query"
                  }
                ]
              },
              "time": {
                "from": "now-1h",
                "to": "now"
              },
              "timepicker": {},
              "timezone": "",
              "title": "Spanmetrics Demo Dashboard 2",
              "uid": "W2gX2zHVk48j",
              "version": 1,
              "weekStart": ""
            }
        node-exporter:
          # Ref: https://grafana.com/grafana/dashboards/1860-node-exporter-full/
          gnetId: 1860
          revision: 31
          datasource:
          - name: DS_PROMETHEUS
            value: prometheus
---
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMAgent
metadata:
  name: victoria-metrics-agent
  namespace: grafana
spec:
  selectAllByDefault: true
  replicaCount: 1
  remoteWrite:
  - url: http://prometheus-server.grafana.svc.cluster.local/api/v1/write
  inlineScrapeConfig: |
    - job_name: k8s-spring-boot-actuator
      metrics_path: /actuator/prometheus
      scheme: http
      kubernetes_sd_configs:
      - role: service
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_port_name]
        regex: management
        action: keep
      headers:
      # https://docs.spring.io/spring-boot/docs/current/actuator-api/htmlsingle/#prometheus.retrieving
      - "Accept: application/openmetrics-text; version=1.0.0; charset=utf-8"
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: opentelemetry-collector
  namespace: otel
spec:
  repo: https://open-telemetry.github.io/opentelemetry-helm-charts
  chart: opentelemetry-collector
  targetNamespace: otel
  valuesContent: |
    mode: deployment
    config:
      connectors:
        spanmetrics:
          histogram:
            explicit:
              buckets:
              - 100us
              - 1ms
              - 2ms
              - 6ms
              - 10ms
              - 50ms
              - 100ms
              - 250ms
              - 500ms
              - 1000ms
              - 1400ms
              - 2000ms
              - 5s
              - 10s
              - 20s
              - 40s
              - 60s
          dimensions:
          - name: http.method
          - name: http.status_code
          dimensions_cache_size: 100000
          aggregation_temporality: "AGGREGATION_TEMPORALITY_CUMULATIVE"
          metrics_flush_interval: 15s
      exporters:
        otlp/tempo:
          endpoint: tempo.grafana.svc.cluster.local:4317
          tls:
            insecure: true
        prometheusremotewrite:
          endpoint: http://prometheus-server.grafana.svc.cluster.local/api/v1/write
          tls:
            insecure: true
          # needed for spanmetricsconnector (https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/connector/spanmetricsconnector)
          target_info:
            enabled: true
        loki:
          endpoint: http://loki.grafana.svc.cluster.local:3100/loki/api/v1/push
          headers:
            X-Scope-OrgID: tenant1
          tls:
            insecure: true
        logging: {}
      extensions:
        health_check: {}
        memory_ballast: {}
        zpages:
          endpoint: localhost:55679
      processors:
        memory_limiter:
          check_interval: 1s
          limit_percentage: 75
          spike_limit_percentage: 15
        batch:
          send_batch_size: 10000
          timeout: 5s
        filter/actuator:
          spans:
            exclude:
              match_type: regexp
              attributes:
              - key: http.route
                value: "^/actuator/.*"
        transform/tempo:
          error_mode: ignore
          # workaround https://github.com/grafana/grafana/issues/54849
          trace_statements:
            - context: span
              statements:
                - replace_pattern(name, "\\*+", "")
                - replace_pattern(attributes["http.route"], "\\*+", "")
            - context: spanevent
              statements:
                - replace_pattern(name, "\\*+", "")
        # https://github.com/open-telemetry/opentelemetry-collector/issues/2310
        tail_sampling:
          # Must be less than metrics_ingestion_time_range_slack in Tempo or tempo span metrics break
          # https://github.com/grafana/tempo/issues/2507
          decision_wait: 20s
          policies:
            - name: drop_noisy_traces_url
              type: string_attribute
              string_attribute:
                key: http.target
                values:
                  - \/metrics
                  - \/actuator*
                  - opentelemetry\.proto
                  - favicon\.ico
                  - \/livez
                  - \/health
                  - \/readyz
                enabled_regex_matching: true
                invert_match: true
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317
            http:
              endpoint: 0.0.0.0:4318
      service:
        telemetry:
          metrics:
            address: 0.0.0.0:8888
        extensions:
          - health_check
          - memory_ballast
          - zpages
        pipelines:
          logs:
            exporters:
              - loki
            processors:
              - memory_limiter
              - batch
            receivers:
              - otlp
          metrics:
            exporters:
              - prometheusremotewrite
            processors:
              - memory_limiter
              - batch
            receivers:
              - otlp
              - spanmetrics
          traces:
            exporters:
              - otlp/tempo
            processors:
              - transform/tempo
              - tail_sampling
              - memory_limiter
              - batch
            receivers:
              - otlp
          traces/spanmetrics:
            exporters:
              - spanmetrics
            processors:
              - tail_sampling
            receivers:
              - otlp
    ports:
      jaeger-compact:
        enabled: false
      jaeger-thrift:
        enabled: false
      jaeger-grpc:
        enabled: false
      zipkin:
        enabled: false
      metrics:
        enabled: true
      zpages:
        enabled: true
        containerPort: 55679
        servicePort: 55679
        protocol: TCP
